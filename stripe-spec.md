I am adding a Stripe Connect integration to my application. Please create a sample integration and add detailed code comments explaining each step. If a value needs to be filled in (like an API key), please mark it with a placeholder comment and provide a helpful error if the value is not present.

The sample integration should onboard users to Connect, create products, and have a simple storefront for their customers to make purchases.

For any UI, please use clean, simple HTML with basic styling. If relevant, use the current style of my application.

The latest preview version of the Stripe API is `2025-08-27.preview` but this will be used automatically by the SDK.

Use the latest beta version of the SDK package (install with the `beta` tag). You can find the latest beta version of the SDK package at https://github.com/stripe/stripe-$LANG/releases.

Please set up flows for the following:

## Use a "Stripe Client" for all requests

Here are some common ways to create a Stripe Client:

```js
const stripeClient = new Stripe("sk_***");
```

```ruby

stripeClient = Stripe::StripeClient.new("sk_***")

```

```python

stripeClient = StripeClient("sk_***")

```

```php

$stripeClient = new \Stripe\StripeClient(['api_key' => "sk_***"]);

```

```java

StripeClient stripeClient = new StripeClient("sk_***");

```

```go

stripeClient := stripe.NewClient("sk_***")

```

```dotnet

var stripeClient = new StripeClient("sk_***");

```

use the `stripeClient` for all stripe related requests.

The stripe version does not need to be set since it will be used automatically by the SDK.

## Creating Connected Accounts

When creating connected accounts, use the V2 API with the following properties:

```js

const account = await stripeClient.v2.core.accounts.create({

  display_name: {From User},

  contact_email: {From User},

  identity: {

    country: 'us',

  },

  dashboard: 'full',

  defaults: {

      responsibilities: {

        fees_collector: 'stripe',

        losses_collector: 'stripe',

      },

   },

  configuration: {

    customer: {},

    merchant: {

       capabilities: {

         card_payments: {

           requested: true,

         },

       },

    },

  },

});

```

Only use the above properties when creating accounts. Never pass type at the top level. **Do not use top level type: 'express' or type: 'standard' or type 'custom'.**

If there is a DB already setup, store a mapping from the user object to the account ID.

The full V2 object can be seen at https://docs.stripe.com/api/v2/core/accounts/object?api-version=2025-08-27.preview

## Onboarding Connected Accounts

Onboard the connected accounts using Stripe Account Links.

Please make a UI where the user can click "Onboard to collect payments" and also see the current status of onboarding. You should use the accounts API directly to get the status of the account. For this demo, always get the account status from the API directly (Do not store in a database).

(This is just an example, code could be different depending on programming language.)

```js
const account = await stripeClient.v2.core.accounts.retrieve(stripeAccountId, {
  include: ["configuration.merchant", "requirements"],
});

const readyToProcessPayments =
  account?.configuration?.merchant?.capabilities?.card_payments?.status ===
  "active";

const requirementsStatus =
  account.requirements?.summary?.minimum_deadline?.status;
const requirementsStatus =
  account.requirements?.summary?.minimum_deadline?.status;

const onboardingComplete =
  requirementsStatus !== "currently_due" && requirementsStatus !== "past_due";
```

## Listen for requirements changes on your connected account

Account requirements can change, often due to changes implemented by financial regulators, card networks, and other financial institutions. To set up webhook notifications of requirement changes, create an event destination to listen for Account v2 update events.

1. In your [Stripe Dashboard](https://dashboard.stripe.com), open the Developers menu by clicking **Developers** in the navigation menu footer, then select **Webhooks**.

1. Click **+ Add destination**.

1. In the Events from section, select **Connected accounts**.

1. Select **Show advanced options**. In the Payload style section, select **Thin**.

1. In the Events field, type “v2” to search for v2 event types. Select **v2.account[requirements].updated** and the **v2.account[configuration.configuration_type].capability_status_updated** type for each configuration type used by your connected accounts.

Configure your application to respond to update events by collecting any updated requirements.

Use the following docs to help you parse 'thin' evevnts. You must use then events for V2 accounts: https://docs.stripe.com/webhooks.md?snapshot-or-thin=thin

You can start a local listener by using the Stripe CLI: https://docs.stripe.com/cli/listen

```bash

stripe listen --thin-events 'v2.core.account[requirements].updated,v2.core.account[.recipient].capability_status_updated,v2.core.account[configuration.merchant].capability_status_updated,v2.core.account[configuration.customer].capability_status_updated' --forward-thin-to <YOUR_LOCAL_ENDPOINT>

```

### Sample code for parsing 'thin' events

```js
const thinEvent = client.parseThinEvent(req.body, sig, webhookSecret);

// Fetch the event data to understand the failure

const event = await client.v2.core.events.retrieve(thinEvent.id);

// Use event.type to determine which event to handle
```

setup handlers for each event type.

## Create Products

Please set up a sample endpoint and user interface to create Stripe products. This should use the `Stripe-Account` header to create products on the connected account.

```

stripeClient.products.create({

    name: name,

    description: description,

    default_price_data: {

        unit_amount: priceInCents,

        currency: currency,

    },

}, {

    stripeAccount: accountId, // Use stripeAccount for the Stripe-Account header

});

```

(This is just an example, code could be different depending on programming language.)

## Display Products

Please create a sample UI (a storefront) that displays the products and allows a connected account's customers to buy a product. There should be one page per connected account (you can use the connected account's ID in the URL, but add a comment telling the user they should use a different identifier in the future).

Make sure to use the connected account header when retrieving products.

```

stripeClient.products.list({

    limit: 20,

    active: true,

    expand: ['data.default_price'],

}, {

    stripeAccount: accountId,

});

```

## Process Charges to connected account

Use a Direct Charge with an application fee to monetize the transaction.

Use hosted checkout for simplicity.

```

stripeClient.checkout.sessions.create(

  {

    line_items: [

      {

        price_data: <Price Data>

        quantity: <Quantity>,

      },

    ],

    payment_intent_data:  {

      // Sample Application Fee

      application_fee_amount: 123,

    },

    mode: 'payment',

    success_url: '<Root URL>/success?session_id={CHECKOUT_SESSION_ID}',

  },

  {

    stripeAccount: <Connected Account ID>,

  }

)

```

(This is just an example, code could be different depending on programming language.)

How the connected account header is passed can differ depending on the programming language (casing or argument order can change). You can see the docs at https://docs.stripe.com/connect/authentication.md or use any stripe docs tools that you have access to.

Here are some common programming languages. The following will help you understand how to pass the connected account header.

Make sure to use the Stripe Client for all requests.

```ruby

stripeClient = Stripe::StripeClient.new("sk_***")



products = stripeClient.v1.products.list(

  {limit: 5},

  {stripe_account: '{{CONNECTED_ACCOUNT_ID}}'},

)

```

```python

stripeClient = StripeClient("sk_***")



products = stripeClient.v1.products.list(

  {"limit": 5},

  {"stripe_account": '{{CONNECTED_ACCOUNT_ID}}'},

)

```

```php

$stripeClient = new \Stripe\StripeClient('sk_***');



$products = $stripeClient->products->all(

  ['limit' => 5],

  ['stripe_account' => '{{CONNECTED_ACCOUNT_ID}}']

);

```

```java

StripeClient stripeClient = new StripeClient("sk_***");



ProductListParams params = ProductListParams.builder().setLimit(5L).build();



RequestOptions requestOptions =

  RequestOptions.builder().setStripeAccount("{{CONNECTED_ACCOUNT_ID}}").build();



StripeCollection<Product> stripeCollection =

  stripeClient.v1().products().list(params, requestOptions);

```

```go

stripeClient := stripe.NewClient("sk_***")

params := &stripe.ProductListParams{}

params.Limit = stripe.Int64(5)

params.SetStripeAccount("{{CONNECTED_ACCOUNT_ID}}")

result := stripeClient.V1Products.List(context.TODO(), params)

```

```dotnet

var options = new ProductListOptions { Limit = 5 };

var requestOptions = new RequestOptions

{

    StripeAccount = "{{CONNECTED_ACCOUNT_ID}}",

};

var stripeClient = new StripeClient("sk_***");

var service = stripeClient.V1.Products;

StripeList<Product> products = service.List(options, requestOptions);

```

## Charge subscription to Connected Account

### Create and charge the subscription

We want to charge a subscription to the connected account. With V2 accounts we can use one ID for both the customer and the connected account.

If you have access to tools, create an example subscription at the platform level. If you don't have access add a placeholder ID.

Add some basic UI on the users dashboard that will allow a connected account to subscribe.

You can create the subscription using a hosted checkout. Use the following code

```

stripe.checkout.sessions.create({

      customer_account: "acct_..." (The connected account ID),

      mode: 'subscription',

      line_items: [

        { price: process.env.PRICE_ID, quantity: 1 },

      ],

      success_url: <SUCCESS_URL>?session_id={CHECKOUT_SESSION_ID}`,

      cancel_url: <CANCEL_URL>,

    });

```

### Add a billing portal

Add a billing portal where the user can manage their subscription.

```

const session = await stripe.billingPortal.sessions.create({

  customer_account: '{{Connected account ID}}',

  return_url: '{{Dashboard URL}}',

});

```

### Webhooks

## Listen to webhooks [Server-side]

When subscriptions are upgraded, downgraded, or canceled, you need to make sure that customers receive only the products or services they're actively subscribed to. Stripe sends notifications of these changes to your integration using _webhooks_ (A webhook is a real-time push notification sent to your application as a JSON payload through HTTPS requests). In the `Event` object, look at the ID for the subscription or the customer to determine which customer the event applies to.

Stripe also sends notifications if an invoice is paid to your integration using _webhooks_ (A webhook is a real-time push notification sent to your application as a JSON payload through HTTPS requests). In the `Event` object, look at the ID for the invoice or the customer to determine which customer the event applies to.

If you haven't set up a webhook endpoint with Stripe before, you can use Stripe's [webhooks documentation](https://docs.stripe.com/webhooks.md) to get started, and then listen for the events described below.

Setup webhooks for subscriptions and store the users subscriptions status in the database if one is setup. If one is not setup add TODO's of where they DB should be written to.

This webhooks do not use thin events.

| Event | Description |

| ------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |

| [customer.subscription.updated](https://docs.stripe.com/api/events/types.md#event_types-customer.subscription.updated) | Listen to this to monitor subscription upgrades and downgrades. For upgrades, check the `subscription.items.data[0].price` attribute in the subscription object to find the price the customer is subscribed to. Then, grant access to the new product. For downgrades, check the same attribute and adjust or revoke access as needed.

When a customer uses the portal to upgrade or downgrade a subscription with a [trial](https://docs.stripe.com/billing/subscriptions/trials.md), the subscription's trial ends immediately when switching to the new price. |

| [customer.subscription.updated](https://docs.stripe.com/api/events/types.md#event_types-customer.subscription.updated) | Listen to this to monitor updates to the subscription quantity. When you receive this event, check the `subscription.items.data[0].quantity` attribute to find the quantity the customer is subscribed to. Then, grant access to the new quantity. |

| [customer.subscription.deleted](https://docs.stripe.com/api/events/types.md#event_types-customer.subscription.deleted) | Listen to this to monitor subscription cancellations. When you receive this event, revoke the customer's access to the product. If you configure the portal to cancel subscriptions at the end of a billing period, listen to the [customer.subscription.updated](https://docs.stripe.com/api/events/types.md#event_types-customer.subscription.updated) event to be notified of cancellations before they occur. If `cancel_at_period_end` is `true`, the subscription is canceled at the end of its billing period.

If a customer changes their mind, they can reactivate their subscription prior to the end of the billing period. When they do this, a [customer.subscription.updated](https://docs.stripe.com/api/events/types.md#event_types-customer.subscription.updated) event is sent. Check that `cancel_at_period_end` is `false` to confirm that they reactivated their subscription. |

| [customer.subscription.updated](https://docs.stripe.com/api/events/types.md#event_types-customer.subscription.updated) | Listen to this for subscriptions that have paused collections. If `subscription.pause_collection` is empty, it means that the subscription has resumed. Otherwise, the subscription collection is paused and `subscription.pause_collection.resumes_at` indicates when the subscription is scheduled to resume. `subscription.pause_collection.behavior` must always be `'void'` if the customer paused their subscription in the customer portal. |

| [payment_method.attached](https://docs.stripe.com/api/events/types.md#event_types-payment_method.attached) | Occurs when a customer adds a payment method. |

| [payment_method.detached](https://docs.stripe.com/api/events/types.md#event_types-payment_method.detached) | Occurs when a customer removes a payment method. |

| [customer.updated](https://docs.stripe.com/api/events/types.md#event_types-customer.updated) | Check the `invoice_settings.default_payment_method` attribute to find the payment method that a customer selected as the new default. If you have subscriptions that override the customer-level default payment method, customers can remove this override. Check the subscription's `default_payment_method` attribute when you receive this event to see if the override was removed. Use this webhook to update any relevant information in your database. All updates must be treated as billing information changes only. Don't use the customer billing email address as a login credential. |

| [customer.tax_id.created](https://docs.stripe.com/api/events/types.md#event_types-customer.tax_id.created) | Occurs when customers manage their tax IDs. Stripe can validate some types of tax IDs. Learn more in the [tax IDs guide](https://docs.stripe.com/billing/customer/tax-ids.md). |

| [customer.tax_id.deleted](https://docs.stripe.com/api/events/types.md#event_types-customer.tax_id.deleted) | Occurs when customers manage their tax IDs. Stripe can validate some types of tax IDs. Learn more in the [tax IDs guide](https://docs.stripe.com/billing/customer/tax-ids.md). |

| [customer.tax_id.updated](https://docs.stripe.com/api/events/types.md#event_types-customer.tax_id.updated) | Listen to this to get validation updates about customer tax IDs. Learn more in the [tax IDs guide](https://docs.stripe.com/billing/customer/tax-ids.md). |

| [billing_portal.configuration.created](https://docs.stripe.com/api/events/types.md#event_types-billing_portal.configuration.created) | Occurs when a configuration is created. |

| [billing_portal.configuration.updated](https://docs.stripe.com/api/events/types.md#event_types-billing_portal.configuration.updated) | Occurs when a configuration is updated. |

| [billing_portal.session.created](https://docs.stripe.com/api/events/types.md#event_types-billing_portal.session.created) | Occurs when a portal session is created. |

## General Tips

Do not use .customer id's for V2 accounts you can get the ID from .customer_account.

Ex:

```

// This will have shape acct_

account_id = subscription.customer_account

```

When in doubt reference the stripe docs.
